<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CondoSaas - Sistema Completo</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { --primary: #2E7D32; --bg: #f5f5f5; --white: #fff; --super: #6200EA; --danger: #D32F2F; --money: #FBC02D; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background-color: var(--bg); color: #333; padding-bottom: 80px; min-height: 100vh; }
        
        /* Layout */
        .app-bar { background: var(--primary); color: white; padding: 16px; position: sticky; top: 0; z-index: 100; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .app-bar.super { background: var(--super); }
        .app-title { font-size: 1.2rem; font-weight: 500; margin-left: 12px; flex: 1; }
        .container { max-width: 1000px; margin: 16px auto; padding: 0 16px; }
        .card { background: var(--white); border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* Buttons */
        .btn { padding: 10px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-super { background: var(--super); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
        .btn-sm { padding: 6px 10px; font-size: 0.8rem; }

        /* Dashboard & Stats */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-val { font-size: 1.8rem; font-weight: bold; color: var(--primary); }
        .stat-val.money { color: var(--money); }
        .stat-label { font-size: 0.8rem; color: #666; text-transform: uppercase; }

        /* Calendar & Forms */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-cell { aspect-ratio: 1; background: #fff; border: 1px solid #eee; border-radius: 4px; display: flex; flex-direction: column; padding: 4px; cursor: pointer; position: relative; }
        .day-cell.today { border: 2px solid var(--primary); }
        .day-dot { width: 6px; height: 6px; border-radius: 50%; margin: 1px; }
        .dots-container { display: flex; flex-wrap: wrap; gap: 2px; margin-top: 4px; }
        .week-day { text-align: center; font-size: 0.8rem; color: #666; padding: 8px 0; }

        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; color: #555; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        .file-upload-box { border: 2px dashed #ddd; padding: 20px; text-align: center; cursor: pointer; border-radius: 4px; }
        .file-upload-box:hover { border-color: var(--primary); background: #f9f9f9; }

        /* Login & Modal */
        .login-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; padding: 20px; }
        .login-card { width: 100%; max-width: 400px; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        
        /* Utils */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #333; color: white; padding: 12px 20px; border-radius: 4px; animation: slideIn 0.3s; display: flex; align-items: center; gap: 10px; }
        .toast.success { border-left: 4px solid #4CAF50; }
        .toast.error { border-left: 4px solid #F44336; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; text-transform: uppercase; font-weight: bold; }
        .badge.pending { background: #E3F2FD; color: #1976D2; }
        .badge.approved { background: #E8F5E9; color: #2E7D32; }
        .badge.maintenance { background: #eee; color: #757575; border: 1px solid #999; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; height: 60px; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 90; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #999; font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .hidden { display: none; }
        
        #loading-screen { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; font-family: sans-serif; }
    </style>
</head>
<body>

    <div id="loading-screen">Carregando Sistema...</div>

    <div id="app" style="display: none;">
        <div class="toast-container">
            <div v-for="(t, i) in toasts" :key="i" class="toast" :class="t.type">
                <i class="material-icons">{{ t.type === 'success' ? 'check_circle' : 'error' }}</i>
                {{ t.message }}
            </div>
        </div>

        <div v-if="!currentUser" class="login-container">
            <div class="login-card">
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="material-icons" style="font-size: 48px; color: var(--primary);">qr_code_scanner</i>
                    <h2>CondoSaas</h2>
                    <p style="color: #666;">Plataforma de Gestão</p>
                </div>
                <form v-if="!isRegistering" @submit.prevent="handleLogin">
                    <div class="form-group"><label class="form-label">E-mail</label><input type="email" v-model="authForm.email" class="form-control" required></div>
                    <div class="form-group"><label class="form-label">Senha</label><input type="password" v-model="authForm.password" class="form-control" required></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;" :disabled="loading">{{ loading ? 'Entrando...' : 'Entrar' }}</button>
                    <div style="text-align: center; margin-top: 15px;"><a href="#" @click.prevent="isRegistering = true">Primeiro acesso? Cadastre-se</a></div>
                </form>
                <form v-else @submit.prevent="handleRegister">
                    <h4 style="margin-bottom: 15px;">Cadastro de Morador</h4>
                    <div class="form-group">
                        <label class="form-label">Código (QR)</label>
                        <div style="display: flex; gap: 5px;"><input type="text" v-model="regForm.condoId" class="form-control" :readonly="hasUrlCode"><i v-if="hasUrlCode" class="material-icons" style="color: green;">check_circle</i></div>
                    </div>
                    <div class="form-group"><label class="form-label">Nome</label><input type="text" v-model="regForm.name" class="form-control" required></div>
                    <div class="form-group"><label class="form-label">Apto/Bloco</label><input type="text" v-model="regForm.apartment" class="form-control" required></div>
                    <div class="form-group"><label class="form-label">E-mail</label><input type="email" v-model="regForm.email" class="form-control" required></div>
                    <div class="form-group"><label class="form-label">Senha</label><input type="password" v-model="regForm.password" class="form-control" required minlength="6"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;" :disabled="loading">{{ loading ? 'Cadastrando...' : 'Cadastrar' }}</button>
                    <div style="text-align: center; margin-top: 15px;"><a href="#" @click.prevent="isRegistering = false">Voltar para Login</a></div>
                </form>
            </div>
        </div>

        <div v-else>
            <div class="app-bar" :class="{ 'super': currentUser.type === 'superuser' }">
                <i class="material-icons">{{ currentUser.type === 'superuser' ? 'admin_panel_settings' : 'apartment' }}</i>
                <span class="app-title">{{ currentUser.type === 'superuser' ? 'Dashboard Admin' : condoName }}</span>
                <button class="btn" style="background: rgba(255,255,255,0.2); padding: 6px;" @click="logout"><i class="material-icons">logout</i></button>
            </div>

            <div class="container">
                
                <div v-if="currentUser.type === 'superuser'">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-val">{{ condoList.length }}</div>
                            <div class="stat-label">Condomínios</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-val">R$ {{ totalMRR }}</div>
                            <div class="stat-label">MRR (Mensal)</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3>Clientes</h3>
                        <button class="btn btn-super" @click="showCondoModal = true"><i class="material-icons">add</i> Novo</button>
                    </div>

                    <div v-for="c in condoList" :key="c.id" class="card">
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <strong>{{ c.name }}</strong>
                                <div style="font-size: 0.9rem; color: #666;">Síndico: {{ c.syndicName }}</div>
                            </div>
                            <span class="badge approved">Ativo</span>
                        </div>
                    </div>
                </div>

                <div v-else>
                    
                    <div v-if="currentView === 'calendar'">
                        <div v-if="currentUser.type === 'syndic'" class="dashboard-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-val money">R$ {{ totalReceivables }}</div>
                                <div class="stat-label">A Receber (Mês)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-val">{{ pendingReservations.length }}</div>
                                <div class="stat-label">Pendentes</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="calendar-header">
                                <button class="btn btn-outline" @click="changeMonth(-1)"><i class="material-icons">chevron_left</i></button>
                                <h3>{{ monthLabel }}</h3>
                                <button class="btn btn-outline" @click="changeMonth(1)"><i class="material-icons">chevron_right</i></button>
                            </div>
                            <div class="calendar-grid">
                                <div class="week-day" v-for="d in ['D','S','T','Q','Q','S','S']">{{ d }}</div>
                                <div v-for="n in paddingDays" class="day-cell empty"></div>
                                <div v-for="day in daysInMonth" class="day-cell" :class="{ 'today': isToday(day) }" @click="selectDate(day)">
                                    <span class="day-number">{{ day }}</span>
                                    <div class="dots-container">
                                        <div v-for="res in getReservationsForDay(day)" class="day-dot" :style="{ background: getStatusColor(res.status) }"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3>Áreas Comuns</h3>
                            <div v-for="space in spaces" :key="space.id" style="border-bottom: 1px solid #eee; padding: 15px 0;">
                                <div style="display: flex; gap: 15px; align-items: center;">
                                    <div :style="{backgroundImage: 'url('+ (space.image || 'https://via.placeholder.com/60') +')'}" style="width: 70px; height: 70px; background-size: cover; border-radius: 8px; background-position: center;"></div>
                                    <div style="flex: 1;">
                                        <strong>{{ space.name }}</strong>
                                        <div style="font-size: 0.9rem; color: #666;">
                                            Capacidade: {{ space.capacity }} <br>
                                            <span style="color: var(--primary); font-weight: bold;" v-if="space.price">R$ {{ space.price }}/reserva</span>
                                            <span v-else style="color: green;">Grátis</span>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary btn-sm" @click="openBookingModal(space)">Reservar</button>
                                </div>
                                <div v-if="currentUser.type === 'syndic'" style="text-align: right; margin-top: 5px;">
                                    <button class="btn btn-outline btn-sm" @click="openBlockModal(space)" style="color: #757575; border-color: #ccc;">Bloquear</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentView === 'reservations'">
                        <h2>Minhas Reservas</h2>
                        <div v-for="res in myReservations" :key="res.id" class="card">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>{{ getSpaceName(res.spaceId) }}</strong>
                                <span class="badge" :class="res.status">{{ res.status }}</span>
                            </div>
                            <p>{{ formatDate(res.date) }} - {{ res.time }}</p>
                            <div v-if="res.price" style="margin-top: 5px; font-weight: bold; color: #555;">Valor: R$ {{ res.price }}</div>
                            <button v-if="res.status === 'pending'" class="btn btn-danger btn-sm" @click="deleteReservation(res.id)" style="margin-top: 10px;">Cancelar</button>
                        </div>
                    </div>

                    <div v-if="currentView === 'finance' && currentUser.type === 'syndic'">
                        <h2>Financeiro</h2>
                        <div class="card">
                            <h3>A Receber (Este Mês)</h3>
                            <div style="font-size: 2.5rem; font-weight: bold; color: var(--money); text-align: center; margin: 20px 0;">
                                R$ {{ totalReceivables }}
                            </div>
                        </div>
                        <h3>Extrato de Reservas</h3>
                        <div v-for="res in paidReservations" :key="res.id" class="card" style="border-left: 4px solid var(--money);">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>{{ getSpaceName(res.spaceId) }}</strong>
                                <span style="font-weight: bold;">R$ {{ res.price }}</span>
                            </div>
                            <div style="font-size: 0.9rem; color: #666;">
                                {{ res.userName }} - {{ formatDate(res.date) }}
                            </div>
                        </div>
                    </div>

                    <div v-if="currentView === 'admin' && currentUser.type === 'syndic'">
                        <h3>Pendências</h3>
                        <div v-if="pendingReservations.length === 0" style="color: #999;">Nada pendente.</div>
                        <div v-for="res in pendingReservations" :key="res.id" class="card" style="border-left: 4px solid orange;">
                            <strong>{{ getSpaceName(res.spaceId) }}</strong>
                            <div style="font-size: 0.9rem;">
                                {{ res.userName }} - {{ formatDate(res.date) }}
                                <div v-if="res.price">Valor: <b>R$ {{ res.price }}</b></div>
                            </div>
                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                <button class="btn btn-primary btn-sm" style="flex: 1;" @click="updateStatus(res, 'approved')">Aprovar & Notificar</button>
                                <button class="btn btn-danger btn-sm" style="flex: 1;" @click="updateStatus(res, 'rejected')">Rejeitar</button>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 30px;">
                            <h3>Cadastrar Área Comum</h3>
                            <div class="form-group"><input type="text" v-model="newSpace.name" class="form-control" placeholder="Nome"></div>
                            <div class="form-group"><input type="number" v-model="newSpace.capacity" class="form-control" placeholder="Capacidade"></div>
                            <div class="form-group"><input type="number" v-model="newSpace.price" class="form-control" placeholder="Valor da Reserva (R$)"></div>
                            <div class="form-group"><input type="text" v-model="newSpace.rules" class="form-control" placeholder="Regras"></div>
                            <div class="form-group">
                                <label>Foto</label>
                                <div class="file-upload-box" @click="$refs.fileInput.click()">
                                    <i class="material-icons">{{ newSpace.image ? 'check_circle' : 'cloud_upload' }}</i>
                                    {{ newSpace.image ? 'Imagem selecionada' : 'Upload de Foto (Max 500KB)' }}
                                </div>
                                <input type="file" ref="fileInput" @change="handleImageUpload" accept="image/*" style="display: none;">
                            </div>
                            <button class="btn btn-primary" @click="addSpace" style="width: 100%;">Salvar</button>
                        </div>
                    </div>

                </div>
            </div>

            <div v-if="currentUser.type !== 'superuser'" class="bottom-nav">
                <div class="nav-item" :class="{active: currentView === 'calendar'}" @click="currentView = 'calendar'"><i class="material-icons">calendar_month</i></div>
                <div class="nav-item" :class="{active: currentView === 'reservations'}" @click="currentView = 'reservations'"><i class="material-icons">receipt_long</i></div>
                <div v-if="currentUser.type === 'syndic'" class="nav-item" :class="{active: currentView === 'finance'}" @click="currentView = 'finance'"><i class="material-icons">attach_money</i></div>
                <div v-if="currentUser.type === 'syndic'" class="nav-item" :class="{active: currentView === 'admin'}" @click="currentView = 'admin'"><i class="material-icons">verified_user</i></div>
            </div>
        </div>

        <div class="modal-overlay" v-if="showModal" @click.self="showModal = false">
            <div class="modal-content">
                <h3>Reservar {{ selectedSpace?.name }}</h3>
                <p v-if="selectedSpace?.price" style="color: var(--primary); font-weight: bold; font-size: 1.1rem; margin-bottom: 10px;">Valor: R$ {{ selectedSpace.price }}</p>
                <div class="form-group"><label>Data</label><input type="date" v-model="form.date" class="form-control"></div>
                <div class="form-group"><label>Horário</label><select v-model="form.time" class="form-control"><option>08:00 - 12:00</option><option>13:00 - 17:00</option><option>18:00 - 22:00</option></select></div>
                <div style="text-align: right; margin-top: 20px;"><button class="btn btn-outline" @click="showModal = false">Cancelar</button> <button class="btn btn-primary" @click="confirmBooking">Confirmar</button></div>
            </div>
        </div>
        
        <div class="modal-overlay" v-if="showCondoModal" @click.self="showCondoModal = false">
            <div class="modal-content">
                <h3>Novo Condomínio</h3>
                <div class="form-group"><input type="text" v-model="newCondo.name" class="form-control" placeholder="Nome"></div>
                <div class="form-group"><input type="text" v-model="newCondo.address" class="form-control" placeholder="Endereço"></div>
                <div class="form-group"><input type="text" v-model="newCondo.syndicName" class="form-control" placeholder="Nome do Síndico"></div>
                <div class="form-group"><input type="email" v-model="newCondo.syndicEmail" class="form-control" placeholder="Email Síndico"></div>
                <div class="form-group"><input type="text" v-model="newCondo.syndicPassword" class="form-control" placeholder="Senha Síndico"></div>
                <div style="text-align: right; margin-top: 20px;"><button class="btn btn-outline" @click="showCondoModal = false">Cancelar</button> <button class="btn btn-super" @click="createCondo">Salvar</button></div>
            </div>
        </div>

        <div class="modal-overlay" v-if="showBlockModal" @click.self="showBlockModal = false">
            <div class="modal-content">
                <h3>Bloquear Data</h3>
                <div class="form-group"><label>Início</label><input type="date" v-model="form.date" class="form-control"></div>
                <div class="form-group"><label>Fim</label><input type="date" v-model="form.endDate" class="form-control"></div>
                <div class="form-group"><label>Motivo</label><input type="text" v-model="form.reason" class="form-control"></div>
                <div style="text-align: right; margin-top: 20px;"><button class="btn btn-outline" @click="showBlockModal = false">Cancelar</button> <button class="btn btn-danger" @click="confirmBlock">Bloquear</button></div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, computed, onMounted, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CHAVES DO USUÁRIO
        const EMAIL_PUBLIC_KEY = "YUkpAHaDZ8R5SJveC"; 
        const EMAIL_SERVICE_ID = "service_xk0afvt";
        const EMAIL_TEMPLATE_ID = "template_i3smkw1";

        const firebaseConfig = {
            apiKey: "AIzaSyDeWvVtINqz07UK-iCZwG8-rfBJN7insDM",
            authDomain: "condosaas-app.firebaseapp.com",
            projectId: "condosaas-app",
            storageBucket: "condosaas-app.firebasestorage.app",
            messagingSenderId: "1094942324011",
            appId: "1:1094942324011:web:49293ce94269e71807416e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        createApp({
            setup() {
                const currentView = ref('calendar');
                const currentUser = ref(null);
                const condoName = ref('');
                const loading = ref(false);
                const toasts = ref([]);
                const spaces = ref([]);
                const reservations = ref([]);
                const condoList = ref([]);
                
                // Forms
                const showModal = ref(false);
                const showCondoModal = ref(false);
                const showBlockModal = ref(false);
                const selectedSpace = ref(null);
                const authForm = ref({ email: '', password: '' });
                const isRegistering = ref(false);
                const hasUrlCode = ref(false);
                const regForm = ref({ condoId: '', name: '', apartment: '', email: '', password: '' });
                const newCondo = ref({});
                const newSpace = ref({ name: '', capacity: '', rules: '', image: '', price: '' });
                const form = ref({ date: '', endDate: '', time: '13:00 - 17:00', reason: '' });

                // Inicialização
                onMounted(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    try { emailjs.init(EMAIL_PUBLIC_KEY); } catch(e) { console.error("EmailJS error", e); }
                    const urlParams = new URLSearchParams(window.location.search);
                    const code = urlParams.get('code');
                    if (code) { isRegistering.value = true; regForm.value.condoId = code; hasUrlCode.value = true; }
                });

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        try {
                            const userDoc = await getDoc(doc(db, "users", user.uid));
                            if (userDoc.exists()) {
                                const data = userDoc.data();
                                currentUser.value = { uid: user.uid, email: user.email, ...data };
                                if (data.type === 'superuser') {
                                    loadSuperData();
                                    nextTick(() => renderChart());
                                } else loadCondoData(data.condoId);
                            }
                        } catch(e) { console.error("Erro Auth DB:", e); }
                    } else { currentUser.value = null; spaces.value = []; reservations.value = []; }
                });

                // DATA
                const loadCondoData = async (condoId) => {
                    const cDoc = await getDoc(doc(db, "condominios", condoId));
                    if (cDoc.exists()) condoName.value = cDoc.data().name;
                    onSnapshot(query(collection(db, "spaces"), where("condoId", "==", condoId)), (snap) => spaces.value = snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    onSnapshot(query(collection(db, "reservations"), where("condoId", "==", condoId)), (snap) => reservations.value = snap.docs.map(d => ({ id: d.id, ...d.data() })));
                };
                const loadSuperData = () => {
                    onSnapshot(collection(db, "condominios"), (snap) => condoList.value = snap.docs.map(d => ({ id: d.id, ...d.data() })));
                };

                const renderChart = () => {
                    if (!window.Chart) return;
                    // ... Lógica de gráfico (opcional)
                };

                const handleImageUpload = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    if (file.size > 500 * 1024) { alert("Máximo 500KB."); return; }
                    const reader = new FileReader();
                    reader.onload = (e) => { newSpace.value.image = e.target.result; showToast("Foto ok!"); };
                    reader.readAsDataURL(file);
                };

                const sendEmail = (emailTo, nameTo, status, spaceName, date) => {
                    if (!window.emailjs) return;
                    emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, {
                        to_email: emailTo, to_name: nameTo, status: status, space: spaceName, date: date
                    }).catch(e => console.error(e));
                };

                // ACTIONS
                const handleLogin = async () => {
                    loading.value = true;
                    try { await signInWithEmailAndPassword(auth, authForm.value.email, authForm.value.password); }
                    catch (e) { showToast("Erro login", "error"); } finally { loading.value = false; }
                };

                // A FUNÇÃO QUE FALTAVA
                const handleRegister = async () => {
                    loading.value = true;
                    try {
                        const condoCheck = await getDoc(doc(db, "condominios", regForm.value.condoId));
                        if (!condoCheck.exists()) throw new Error("Condomínio não encontrado");
                        const cred = await createUserWithEmailAndPassword(auth, regForm.value.email, regForm.value.password);
                        await setDoc(doc(db, "users", cred.user.uid), {
                            name: regForm.value.name, apartment: regForm.value.apartment, type: 'resident', condoId: regForm.value.condoId, email: regForm.value.email
                        });
                        showToast("Conta criada!", "success");
                    } catch (e) { showToast(e.message, "error"); } finally { loading.value = false; }
                };

                const createCondo = async () => {
                    if(!newCondo.value.name) return alert("Preencha tudo");
                    try {
                        const cRef = await addDoc(collection(db, "condominios"), { name: newCondo.value.name, address: newCondo.value.address, syndicName: newCondo.value.syndicName, createdAt: new Date().toISOString() });
                        const cred = await createUserWithEmailAndPassword(auth, newCondo.value.syndicEmail, newCondo.value.syndicPassword);
                        await setDoc(doc(db, "users", cred.user.uid), { name: newCondo.value.syndicName, email: newCondo.value.syndicEmail, type: 'syndic', condoId: cRef.id });
                        alert("Condomínio Criado!"); window.location.reload();
                    } catch(e) { showToast(e.message, "error"); }
                };

                const addSpace = async () => {
                    if(!newSpace.value.name) return alert("Nome obrigatório");
                    try {
                        await addDoc(collection(db, "spaces"), { ...newSpace.value, condoId: currentUser.value.condoId });
                        showToast("Salvo!"); newSpace.value = { name: '', capacity: '', rules: '', image: '', price: '' };
                    } catch(e) { showToast("Erro", "error"); }
                };

                const confirmBooking = async () => {
                    try {
                        const price = selectedSpace.value.price || 0;
                        await addDoc(collection(db, "reservations"), {
                            condoId: currentUser.value.condoId, spaceId: selectedSpace.value.id, userId: currentUser.value.uid,
                            userName: currentUser.value.name, userEmail: currentUser.value.email, date: form.value.date, time: form.value.time, status: 'pending', price: price
                        });
                        showModal.value = false; showToast("Solicitado!");
                    } catch(e) { showToast("Erro", "error"); }
                };

                const updateStatus = async (res, status) => {
                    await updateDoc(doc(db, "reservations", res.id), { status });
                    if(res.userEmail) sendEmail(res.userEmail, res.userName, status === 'approved' ? 'Aprovada' : 'Rejeitada', getSpaceName(res.spaceId), res.date);
                    showToast(`Reserva ${status}!`);
                };

                const confirmBlock = async () => {
                    if(!form.value.date || !form.value.endDate) return alert("Datas obrigatórias");
                    const start = new Date(form.value.date); const end = new Date(form.value.endDate);
                    loading.value = true;
                    try {
                        let loop = new Date(start);
                        while(loop <= end) {
                             await addDoc(collection(db, "reservations"), {
                                condoId: currentUser.value.condoId, spaceId: selectedSpace.value.id, userId: currentUser.value.uid,
                                userName: "BLOQUEIO", date: loop.toISOString().split('T')[0], time: "DIA TODO", status: 'maintenance', reason: form.value.reason
                             });
                             loop.setDate(loop.getDate() + 1);
                        }
                        showBlockModal.value = false; showToast("Bloqueado!");
                    } catch(e) { console.error(e); } finally { loading.value = false; }
                };

                // Helpers
                const logout = () => signOut(auth);
                const showToast = (m,t) => { toasts.value.push({message:m, type:t}); setTimeout(()=>toasts.value.shift(),3000); };
                const getSpaceName = (id) => spaces.value.find(s=>s.id===id)?.name || 'Área';
                const formatDate = (d) => d?.split('-').reverse().join('/');
                const deleteReservation = async (id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, "reservations", id)); };
                const getRegistrationLink = () => window.location.href.split('?')[0] + `?code=${currentUser.value.condoId}`;
                const myReservations = computed(() => reservations.value.filter(r => r.userId === currentUser.value?.uid));
                const pendingReservations = computed(() => reservations.value.filter(r => r.status === 'pending'));
                const paidReservations = computed(() => reservations.value.filter(r => r.status === 'approved' && r.price > 0));
                const totalReceivables = computed(() => reservations.value.filter(r => r.status === 'approved' && r.price).reduce((acc, curr) => acc + Number(curr.price), 0));
                const totalMRR = computed(() => condoList.value.length * 150); 
                const currentDate = ref(new Date());
                const monthLabel = computed(() => currentDate.value.toLocaleString('pt-BR', { month: 'long', year: 'numeric' }));
                const daysInMonth = computed(() => new Date(currentDate.value.getFullYear(), currentDate.value.getMonth() + 1, 0).getDate());
                const paddingDays = computed(() => new Date(currentDate.value.getFullYear(), currentDate.value.getMonth(), 1).getDay());
                const changeMonth = (d) => currentDate.value = new Date(currentDate.value.setMonth(currentDate.value.getMonth() + d));
                const isToday = (d) => d === new Date().getDate() && currentDate.value.getMonth() === new Date().getMonth();
                const getReservationsForDay = (d) => {
                    const dt = `${currentDate.value.getFullYear()}-${String(currentDate.value.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    return reservations.value.filter(r => r.date === dt && r.status !== 'rejected');
                };
                const getStatusColor = (s) => s==='maintenance'?'#757575':(s==='approved'?'#4CAF50':(s==='pending'?'#2196F3':'#F44336'));

                return {
                    authForm, regForm, isRegistering, handleLogin, handleRegister, hasUrlCode, currentUser, condoName, loading, toasts, currentView, spaces, reservations, condoList,
                    newCondo, newSpace, createCondo, addSpace, handleImageUpload, confirmBlock,
                    showModal, showCondoModal, showBlockModal, selectedSpace, form, openBookingModal: (s) => { selectedSpace.value=s; showModal.value=true; }, confirmBooking,
                    openBlockModal: (s) => { selectedSpace.value=s; showBlockModal.value=true; },
                    myReservations, pendingReservations, paidReservations, updateStatus, deleteReservation,
                    monthLabel, daysInMonth, paddingDays, changeMonth, isToday, getReservationsForDay, getStatusColor, getSpaceName, formatDate, logout,
                    totalReceivables, totalMRR, getRegistrationLink
                };
            }
        }).mount('#app');
    </script>
</body>
</html>