<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CondoSaas | Gestão</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="loading-screen">
        <div class="loader-content">
            <div class="logo-pulse"><i class="material-icons-round">apartment</i></div>
            <span class="loading-text">Carregando...</span>
        </div>
    </div>

    <div id="app" v-cloak>
        <div class="toast-container">
            <div v-for="(t, i) in toasts" :key="i" class="toast" :class="t.type">
                <i class="material-icons-round">{{ t.type === 'success' ? 'check_circle' : 'error_outline' }}</i>
                <span>{{ t.message }}</span>
            </div>
        </div>

        <div v-if="!currentUser" class="auth-wrapper">
            <div class="auth-box">
                <div class="auth-banner">
                    <div class="brand-hero"><i class="material-icons-round">domain_add</i><h1>CondoSaas</h1></div>
                    <p>Gestão condominial inteligente e descomplicada.</p>
                </div>
                <div class="auth-content">
                    <form v-if="!isRegistering" @submit.prevent="handleLogin" class="auth-form animate-fade">
                        <div class="header-text"><h2>Bem-vindo</h2><p>Acesse sua conta para gerenciar.</p></div>
                        <div class="input-group"><label>E-mail</label><input type="email" v-model="authForm.email" required class="modern-input"></div>
                        <div class="input-group"><label>Senha</label><input type="password" v-model="authForm.password" required class="modern-input"></div>
                        <button type="submit" class="btn btn-primary btn-lg w-100" :disabled="loading">{{ loading ? 'Entrando...' : 'Acessar' }}</button>
                        <div class="auth-footer"><a href="#" @click.prevent="isRegistering = true">Criar uma nova conta</a></div>
                    </form>
                    <form v-else @submit.prevent="handleRegister" class="auth-form animate-fade">
                        <div class="header-text"><h2>Criar Conta</h2><p>Preencha os dados abaixo.</p></div>
                        <div class="input-group">
                            <label>Código do Condomínio</label>
                            <div class="input-icon-wrapper">
                                <input type="text" v-model="regForm.condoId" :readonly="hasUrlCode" placeholder="Código" class="modern-input">
                                <i v-if="hasUrlCode" class="material-icons-round text-success">check_circle</i>
                            </div>
                        </div>
                        <div class="row-2">
                            <div class="input-group"><label>Nome</label><input type="text" v-model="regForm.name" required class="modern-input"></div>
                            <div class="input-group"><label>Apto/Bloco</label><input type="text" v-model="regForm.apartment" required class="modern-input"></div>
                        </div>
                        <div class="input-group"><label>E-mail</label><input type="email" v-model="regForm.email" required class="modern-input"></div>
                        <div class="input-group"><label>Senha</label><input type="password" v-model="regForm.password" required class="modern-input"></div>
                        <button type="submit" class="btn btn-primary btn-lg w-100" :disabled="loading">{{ loading ? 'Criando...' : 'Finalizar' }}</button>
                        <div class="auth-footer"><a href="#" @click.prevent="isRegistering = false">Voltar ao Login</a></div>
                    </form>
                </div>
            </div>
        </div>

        <div v-else class="app-layout">
            
            <aside class="sidebar">
                <div class="brand">
                    <div class="logo-box"><i class="material-icons-round">apartment</i></div>
                    <span class="brand-text">CondoSaas</span>
                </div>
                
                <nav class="nav-menu">
                    <div v-if="currentUser.type === 'superuser'">
                        <div class="nav-label">PLATAFORMA</div>
                        <a href="#" class="nav-item active"><i class="material-icons-round">analytics</i> <span>Visão Geral</span></a>
                    </div>

                    <div v-else>
                        <div class="nav-label">PRINCIPAL</div>
                        <a href="#" class="nav-item" :class="{active: currentView === 'calendar'}" @click="currentView = 'calendar'"><i class="material-icons-round">calendar_month</i> <span>Agenda</span></a>
                        <a href="#" class="nav-item" :class="{active: currentView === 'reservations'}" @click="currentView = 'reservations'"><i class="material-icons-round">confirmation_number</i> <span>Minhas Reservas</span></a>
                        
                        <div v-if="currentUser.type === 'syndic'" class="nav-label mt-4">GESTÃO</div>
                        <a href="#" v-if="currentUser.type === 'syndic'" class="nav-item" :class="{active: currentView === 'finance'}" @click="currentView = 'finance'"><i class="material-icons-round">account_balance_wallet</i> <span>Financeiro</span></a>
                        <a href="#" v-if="currentUser.type === 'syndic'" class="nav-item" :class="{active: currentView === 'admin'}" @click="currentView = 'admin'"><i class="material-icons-round">grid_view</i> <span>Admin</span></a>
                    </div>
                </nav>

                <div class="user-pill">
                    <div class="avatar">{{ currentUser.name ? currentUser.name.charAt(0) : 'U' }}</div>
                    <div class="user-meta">
                        <strong>{{ currentUser.name || 'Usuário' }}</strong>
                        <span>{{ currentUser.type === 'superuser' ? 'Admin Geral' : (currentUser.type === 'syndic' ? 'Síndico' : 'Morador') }}</span>
                    </div>
                    <button @click="logout" class="btn-icon-mini"><i class="material-icons-round">logout</i></button>
                </div>
            </aside>

            <main class="main-content">
                <header class="top-header">
                    <div class="page-title">
                        <h1>{{ getTitle() }}</h1>
                        <span v-if="currentUser.type !== 'superuser'" class="condo-tag"><i class="material-icons-round">location_on</i> {{ condoName }}</span>
                    </div>
                </header>

                <div class="content-body">
                    
                    <div v-if="currentUser.type === 'superuser'" class="animate-fade">
                        <div class="kpi-grid">
                            <div class="kpi-card purple">
                                <div class="kpi-icon"><i class="material-icons-round">domain</i></div>
                                <div><h3>{{ condoList.length }}</h3><p>Condomínios</p></div>
                            </div>
                            <div class="kpi-card green">
                                <div class="kpi-icon"><i class="material-icons-round">payments</i></div>
                                <div><h3>R$ {{ totalMRR }}</h3><p>Receita Mensal</p></div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-icon" style="background: #3B82F6;"><i class="material-icons-round">groups</i></div>
                                <div><h3>{{ condoList.length * 45 }}</h3><p>Usuários Est.</p></div>
                            </div>
                        </div>

                        <div class="section-title">
                            <h3>Gestão de Clientes</h3>
                            <button class="btn btn-primary btn-sm" @click="showCondoModal = true"><i class="material-icons-round">add</i> Novo Cliente</button>
                        </div>

                        <div class="card no-padding">
                            <table class="modern-table">
                                <thead><tr><th>Condomínio</th><th>Síndico / Email</th><th>Status</th><th>Ações</th></tr></thead>
                                <tbody>
                                    <tr v-for="c in condoList" :key="c.id" :style="{ opacity: c.suspended ? 0.6 : 1 }">
                                        <td><strong>{{ c.name }}</strong><br><small class="text-muted">{{ c.address }}</small></td>
                                        <td>{{ c.syndicName }}<br><small class="text-muted">{{ c.syndicEmail || 'N/A' }}</small></td>
                                        <td><span class="status-pill" :class="c.suspended ? 'pending' : 'approved'">{{ c.suspended ? 'SUSPENSO' : 'ATIVO' }}</span></td>
                                        <td>
                                            <button class="btn-icon-mini" :title="c.suspended ? 'Ativar' : 'Suspender'" @click="toggleCondoStatus(c)">
                                                <i class="material-icons-round" :style="{ color: c.suspended ? 'green' : 'red' }">{{ c.suspended ? 'play_circle' : 'pause_circle' }}</i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div v-if="currentView === 'calendar'" class="animate-fade">
                        <div class="calendar-layout">
                            <div class="card calendar-widget">
                                <div class="widget-header">
                                    <button class="nav-btn" @click="changeMonth(-1)"><i class="material-icons-round">chevron_left</i></button><h3>{{ monthLabel }}</h3><button class="nav-btn" @click="changeMonth(1)"><i class="material-icons-round">chevron_right</i></button>
                                </div>
                                <div class="days-grid">
                                    <div class="d-head" v-for="d in ['Dom','Seg','Ter','Qua','Qui','Sex','Sab']">{{ d }}</div>
                                    <div v-for="n in paddingDays" class="d-cell empty"></div>
                                    <div v-for="day in daysInMonth" class="d-cell" :class="{ 'today': isToday(day) }" @click="selectDate(day)">
                                        <span>{{ day }}</span>
                                        <div class="dots"><div v-for="res in getReservationsForDay(day)" class="dot" :style="{ background: getStatusColor(res.status) }"></div></div>
                                    </div>
                                </div>
                                <div class="cal-legend">
                                    <small><span class="dot-sample green"></span> Aprovado</small><small><span class="dot-sample blue"></span> Pendente</small><small><span class="dot-sample gray"></span> Bloqueio</small>
                                </div>
                            </div>
                            <div class="spaces-grid">
                                <div v-for="space in spaces" :key="space.id" class="space-item">
                                    <div class="space-image" :style="{backgroundImage: 'url('+ (space.image || 'https://via.placeholder.com/150') +')'}">
                                        <div class="price-chip" :class="{'free': !space.price}">{{ space.price ? 'R$ '+space.price : 'Grátis' }}</div>
                                    </div>
                                    <div class="space-details">
                                        <h4>{{ space.name }}</h4>
                                        <p><i class="material-icons-round">group</i> {{ space.capacity }} pessoas</p>
                                        <div class="space-btns">
                                            <button class="btn btn-outline btn-sm w-100" @click="openBookingModal(space)">Reservar</button>
                                            <button v-if="currentUser.type === 'syndic'" class="btn btn-icon btn-sm" @click="openBlockModal(space)"><i class="material-icons-round">block</i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentView === 'reservations'" class="animate-fade">
                        <div v-if="myReservations.length === 0" class="empty-state">
                            <div class="empty-img"><i class="material-icons-round">event_note</i></div><h3>Nenhuma reserva</h3><p>Suas reservas aparecerão aqui.</p>
                        </div>
                        <div class="tickets-list">
                            <div v-for="res in myReservations" :key="res.id" class="ticket-card">
                                <div class="ticket-left"><span class="day">{{ res.date.split('-')[2] }}</span><span class="month">{{ res.date.split('-')[1] }}</span></div>
                                <div class="ticket-mid"><h4>{{ getSpaceName(res.spaceId) }}</h4><p>{{ res.time }}</p><span class="status-pill" :class="res.status">{{ res.status }}</span></div>
                                <div class="ticket-right" v-if="res.status === 'pending'"><button class="btn-trash" @click="deleteReservation(res.id)"><i class="material-icons-round">delete</i></button></div>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentView === 'admin' && currentUser.type === 'syndic'" class="animate-fade">
                        <div class="invite-banner">
                            <div class="invite-txt"><h3>Convidar Moradores</h3><p>Código: <strong>{{ currentUser.condoId }}</strong></p><div class="link-copy"><input type="text" :value="getRegistrationLink()" readonly></div></div>
                            <div class="qr-code-bg"><img :src="'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + getRegistrationLink()" alt="QR"></div>
                        </div>
                        <div class="admin-columns">
                            <div class="card">
                                <div class="card-title"><h3>Aprovações</h3><span class="badge-count" v-if="pendingReservations.length">{{ pendingReservations.length }}</span></div>
                                <div class="approval-list">
                                    <div v-if="pendingReservations.length === 0" class="no-data">Tudo em dia!</div>
                                    <div v-for="res in pendingReservations" :key="res.id" class="approval-row">
                                        <div class="user-info"><strong>{{ getSpaceName(res.spaceId) }}</strong><span>{{ res.userName }} • {{ formatDate(res.date) }}</span></div>
                                        <div class="actions"><button class="btn-circle approve" @click="updateStatus(res, 'approved')"><i class="material-icons-round">check</i></button><button class="btn-circle reject" @click="updateStatus(res, 'rejected')"><i class="material-icons-round">close</i></button></div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title"><h3>Nova Área</h3></div>
                                <div class="form-stack">
                                    <input type="text" v-model="newSpace.name" class="modern-input" placeholder="Nome">
                                    <div class="row-2"><input type="number" v-model="newSpace.capacity" class="modern-input" placeholder="Capacidade"><input type="number" v-model="newSpace.price" class="modern-input" placeholder="Preço (R$)"></div>
                                    <label class="upload-btn"><input type="file" @change="handleImageUpload" accept="image/*"><i class="material-icons-round">cloud_upload</i><span>{{ newSpace.image ? 'Foto Pronta!' : 'Enviar Foto' }}</span></label>
                                    <button class="btn btn-primary w-100" @click="addSpace">Salvar Área</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentView === 'finance'" class="animate-fade">
                        <div class="finance-card"><small>Receita Pendente</small><h2>R$ {{ totalReceivables }}</h2><div class="trend"><i class="material-icons-round">trending_up</i> Este mês</div></div>
                        <div class="card no-padding mt-4">
                            <table class="modern-table">
                                <thead><tr><th>Morador</th><th>Área</th><th>Data</th><th>Valor</th></tr></thead>
                                <tbody><tr v-for="res in paidReservations" :key="res.id"><td>{{ res.userName }}</td><td>{{ getSpaceName(res.spaceId) }}</td><td>{{ formatDate(res.date) }}</td><td class="text-green">+ R$ {{ res.price }}</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>

            <nav class="mobile-nav" v-if="currentUser">
                <a href="#" :class="{active: currentView === 'calendar'}" @click="currentView = 'calendar'"><i class="material-icons-round">calendar_month</i></a>
                <a href="#" :class="{active: currentView === 'reservations'}" @click="currentView = 'reservations'"><i class="material-icons-round">confirmation_number</i></a>
                <div v-if="currentUser.type === 'superuser'" class="fab" @click="showCondoModal = true"><i class="material-icons-round">add</i></div>
                <div v-else class="fab" @click="openBookingModal(spaces[0])" v-if="spaces.length"><i class="material-icons-round">add</i></div>
                <a href="#" v-if="currentUser.type !== 'resident'" :class="{active: currentView === 'finance'}" @click="currentView = 'finance'"><i class="material-icons-round">account_balance_wallet</i></a>
                <a href="#" v-if="currentUser.type !== 'resident'" :class="{active: currentView === 'admin'}" @click="currentView = 'admin'"><i class="material-icons-round">grid_view</i></a>
            </nav>
        </div>

        <div class="modal-backdrop" v-if="showModal || showCondoModal || showBlockModal" @click.self="closeAllModals">
            <div class="modal-window" v-if="showModal">
                <div class="modal-h"><h3>Nova Reserva</h3><button @click="closeAllModals"><i class="material-icons-round">close</i></button></div>
                <div class="modal-b">
                    <p class="mb-3 text-muted">Reservando: <strong>{{ selectedSpace?.name }}</strong></p>
                    <div class="input-group"><label>Data</label><input type="date" v-model="form.date" class="modern-input"></div>
                    <div class="input-group"><label>Horário</label><select v-model="form.time" class="modern-input"><option>08:00 - 12:00</option><option>13:00 - 17:00</option><option>18:00 - 22:00</option></select></div>
                </div>
                <div class="modal-f"><button class="btn btn-primary w-100" @click="confirmBooking">Confirmar</button></div>
            </div>
            <div class="modal-window" v-if="showBlockModal">
                <div class="modal-h"><h3>Bloquear Data</h3><button @click="closeAllModals"><i class="material-icons-round">close</i></button></div>
                <div class="modal-b">
                    <div class="input-group"><label>Início</label><input type="date" v-model="form.date" class="modern-input"></div>
                    <div class="input-group"><label>Fim</label><input type="date" v-model="form.endDate" class="modern-input"></div>
                    <div class="input-group"><label>Motivo</label><input type="text" v-model="form.reason" class="modern-input"></div>
                </div>
                <div class="modal-f"><button class="btn btn-danger w-100" @click="confirmBlock">Confirmar Bloqueio</button></div>
            </div>
            <div class="modal-window" v-if="showCondoModal">
                <div class="modal-h"><h3>Novo Cliente</h3><button @click="closeAllModals"><i class="material-icons-round">close</i></button></div>
                <div class="modal-b">
                    <input type="text" v-model="newCondo.name" class="modern-input mb-3" placeholder="Nome Condomínio">
                    <input type="text" v-model="newCondo.address" class="modern-input mb-3" placeholder="Endereço">
                    <input type="text" v-model="newCondo.syndicName" class="modern-input mb-3" placeholder="Nome Síndico">
                    <input type="email" v-model="newCondo.syndicEmail" class="modern-input mb-3" placeholder="Email Síndico">
                    <input type="text" v-model="newCondo.syndicPassword" class="modern-input" placeholder="Senha">
                </div>
                <div class="modal-f"><button class="btn btn-primary w-100" @click="createCondo">Cadastrar</button></div>
            </div>
        </div>
    </div>
    <script type="module" src="src/main.js"></script>
</body>
</html>