<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CondoSaas - Gestão Completa</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { --primary: #2E7D32; --bg: #f5f5f5; --white: #fff; --super: #6200EA; --danger: #D32F2F; --maint: #757575; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background-color: var(--bg); color: #333; padding-bottom: 80px; min-height: 100vh; }
        
        /* Layout */
        .app-bar { background: var(--primary); color: white; padding: 16px; position: sticky; top: 0; z-index: 100; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .app-bar.super { background: var(--super); }
        .app-title { font-size: 1.2rem; font-weight: 500; margin-left: 12px; flex: 1; }
        .container { max-width: 1000px; margin: 16px auto; padding: 0 16px; }
        
        /* UI Components */
        .card { background: var(--white); border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn { padding: 10px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-super { background: var(--super); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
        .btn-sm { padding: 6px 10px; font-size: 0.8rem; }
        
        /* Login */
        .login-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; padding: 20px; }
        .login-card { width: 100%; max-width: 400px; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; color: #555; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        .form-control[readonly] { background-color: #eee; cursor: not-allowed; }
        
        /* Calendário */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .week-day { text-align: center; font-size: 0.8rem; color: #666; padding: 8px 0; }
        .day-cell { aspect-ratio: 1; background: #fff; border: 1px solid #eee; border-radius: 4px; display: flex; flex-direction: column; padding: 4px; cursor: pointer; position: relative; }
        .day-cell.today { border: 2px solid var(--primary); }
        .day-dot { width: 6px; height: 6px; border-radius: 50%; margin: 1px; }
        .dots-container { display: flex; flex-wrap: wrap; gap: 2px; margin-top: 4px; }
        
        /* Utilitários */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #333; color: white; padding: 12px 20px; border-radius: 4px; animation: slideIn 0.3s; display: flex; align-items: center; gap: 10px; }
        .toast.success { border-left: 4px solid #4CAF50; }
        .toast.error { border-left: 4px solid #F44336; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; text-transform: uppercase; font-weight: bold; }
        .badge.pending { background: #E3F2FD; color: #1976D2; }
        .badge.approved { background: #E8F5E9; color: #2E7D32; }
        .badge.maintenance { background: #eee; color: #757575; border: 1px solid #999; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; height: 60px; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 90; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #999; font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item i { font-size: 24px; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div id="app">
        <div class="toast-container">
            <div v-for="(t, i) in toasts" :key="i" class="toast" :class="t.type">
                <i class="material-icons">{{ t.type === 'success' ? 'check_circle' : 'error' }}</i>
                {{ t.message }}
            </div>
        </div>

        <div v-if="!currentUser" class="login-container">
            <div class="login-card">
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="material-icons" style="font-size: 48px; color: var(--primary);">qr_code_scanner</i>
                    <h2>CondoSaas</h2>
                    <p style="color: #666;">Acesso ao Morador</p>
                </div>

                <form v-if="!isRegistering" @submit.prevent="handleLogin">
                    <div class="form-group">
                        <label class="form-label">E-mail</label>
                        <input type="email" v-model="authForm.email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Senha</label>
                        <input type="password" v-model="authForm.password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;" :disabled="loading">
                        {{ loading ? 'Entrando...' : 'Entrar' }}
                    </button>
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" @click.prevent="isRegistering = true" style="font-size: 0.9rem; color: var(--primary);">Primeiro acesso? Cadastre-se</a>
                    </div>
                </form>
                
                <form v-else @submit.prevent="handleRegister">
                    <h4 style="margin-bottom: 15px;">Cadastro de Morador</h4>
                    
                    <div class="form-group">
                        <label class="form-label">Código do Condomínio (QR Code)</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" v-model="regForm.condoId" class="form-control" placeholder="Cole ou escaneie" :readonly="hasUrlCode">
                            <i v-if="hasUrlCode" class="material-icons" style="color: green; padding-top: 10px;">check_circle</i>
                        </div>
                        <small style="color: #666; font-size: 0.8rem;">Solicite este código ao síndico ou use o QR Code.</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Nome Completo</label>
                        <input type="text" v-model="regForm.name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Apartamento / Bloco</label>
                        <input type="text" v-model="regForm.apartment" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">E-mail</label>
                        <input type="email" v-model="regForm.email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Senha</label>
                        <input type="password" v-model="regForm.password" class="form-control" required minlength="6">
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;" :disabled="loading">
                        {{ loading ? 'Criando Conta...' : 'Cadastrar' }}
                    </button>
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" @click.prevent="isRegistering = false" style="font-size: 0.9rem;">Voltar para Login</a>
                    </div>
                </form>
            </div>
        </div>

        <div v-else>
            <div class="app-bar" :class="{ 'super': currentUser.type === 'superuser' }">
                <i class="material-icons">{{ currentUser.type === 'superuser' ? 'admin_panel_settings' : 'apartment' }}</i>
                <span class="app-title">{{ currentUser.type === 'superuser' ? 'Admin Geral' : condoName }}</span>
                <button class="btn" style="background: rgba(255,255,255,0.2); padding: 6px;" @click="logout"><i class="material-icons">logout</i></button>
            </div>

            <div class="container">
                
                <div v-if="currentUser.type === 'superuser'">
                    <div class="card">
                        <h3>Novo Condomínio</h3>
                        <div class="form-group"><input type="text" v-model="newCondo.name" class="form-control" placeholder="Nome do Condomínio"></div>
                        <div class="form-group"><input type="text" v-model="newCondo.syndicEmail" class="form-control" placeholder="Email do Síndico"></div>
                        <div class="form-group"><input type="text" v-model="newCondo.syndicPassword" class="form-control" placeholder="Senha Inicial"></div>
                        <button class="btn btn-super" @click="createCondo" style="width: 100%;">Cadastrar</button>
                    </div>
                    <h3>Condomínios Ativos: {{ condoList.length }}</h3>
                    <div v-for="c in condoList" :key="c.id" class="card">
                        <strong>{{ c.name }}</strong><br>
                        <small>ID: {{ c.id }}</small>
                    </div>
                </div>

                <div v-else>
                    
                    <div v-if="currentView === 'calendar'">
                        <div class="card">
                            <div class="calendar-header">
                                <button class="btn btn-outline" @click="changeMonth(-1)"><i class="material-icons">chevron_left</i></button>
                                <h3>{{ monthLabel }}</h3>
                                <button class="btn btn-outline" @click="changeMonth(1)"><i class="material-icons">chevron_right</i></button>
                            </div>
                            <div class="calendar-grid">
                                <div class="week-day" v-for="d in ['D','S','T','Q','Q','S','S']">{{ d }}</div>
                                <div v-for="n in paddingDays" class="day-cell empty"></div>
                                <div v-for="day in daysInMonth" class="day-cell" :class="{ 'today': isToday(day) }" @click="selectDate(day)">
                                    <span class="day-number">{{ day }}</span>
                                    <div class="dots-container">
                                        <div v-for="res in getReservationsForDay(day)" class="day-dot" 
                                             :style="{ background: getStatusColor(res.status) }"
                                             :title="res.status === 'maintenance' ? 'Manutenção' : 'Reservado'"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.8rem; display: flex; gap: 10px; justify-content: center;">
                                <span style="display:flex;align-items:center"><div class="day-dot" style="background:#4CAF50;margin-right:4px"></div> Confirmado</span>
                                <span style="display:flex;align-items:center"><div class="day-dot" style="background:#757575;margin-right:4px"></div> Bloqueado</span>
                            </div>
                        </div>

                        <div class="card">
                            <h3>Áreas Comuns</h3>
                            <div v-if="spaces.length === 0" style="padding: 20px; text-align: center; color: #999;">Nenhuma área cadastrada.</div>
                            
                            <div v-for="space in spaces" :key="space.id" style="border-bottom: 1px solid #eee; padding: 15px 0;">
                                <div style="display: flex; gap: 15px; align-items: center;">
                                    <img :src="space.image || 'https://via.placeholder.com/60'" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                                    <div style="flex: 1;">
                                        <strong>{{ space.name }}</strong>
                                        <div style="font-size: 0.8rem; color: #666;">Capacidade: {{ space.capacity }} pessoas</div>
                                        <div style="font-size: 0.75rem; color: var(--primary);">{{ space.rules }}</div>
                                    </div>
                                    <button class="btn btn-primary btn-sm" @click="openBookingModal(space)">Reservar</button>
                                </div>
                                <div v-if="currentUser.type === 'syndic'" style="margin-top: 10px; text-align: right;">
                                    <button class="btn btn-outline btn-sm" @click="openBlockModal(space)" style="color: #757575; border-color: #757575;">
                                        <i class="material-icons" style="font-size: 14px;">block</i> Bloquear Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentView === 'reservations'">
                        <h2>Minhas Reservas</h2>
                        <div v-for="res in myReservations" :key="res.id" class="card">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>{{ getSpaceName(res.spaceId) }}</strong>
                                <span class="badge" :class="res.status">{{ res.status }}</span>
                            </div>
                            <p>{{ formatDate(res.date) }} - {{ res.time }}</p>
                            <button v-if="res.status === 'pending'" class="btn btn-danger btn-sm" @click="deleteReservation(res.id)" style="margin-top: 10px;">Cancelar</button>
                        </div>
                    </div>

                    <div v-if="currentView === 'admin' && currentUser.type === 'syndic'">
                        
                        <div class="card" style="background: #E3F2FD; border: 1px solid #BBDEFB;">
                            <h3>QR Code de Acesso</h3>
                            <p style="font-size: 0.9rem; margin-bottom: 15px;">Imprima este código para os moradores se cadastrarem sozinhos.</p>
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px;">
                                <img :src="'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + getRegistrationLink()" alt="QR Code">
                                <p style="margin-top: 10px; font-weight: bold; font-family: monospace;">COD: {{ currentUser.condoId }}</p>
                            </div>
                        </div>

                        <div class="card">
                            <h3>Cadastrar Área Comum</h3>
                            <div class="form-group">
                                <label class="form-label">Nome da Área</label>
                                <input type="text" v-model="newSpace.name" class="form-control" placeholder="Ex: Salão de Festas">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Capacidade</label>
                                <input type="number" v-model="newSpace.capacity" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Regras de Uso (Opcional)</label>
                                <input type="text" v-model="newSpace.rules" class="form-control" placeholder="Ex: Som até as 22h. Limpeza inclusa.">
                            </div>
                            <div class="form-group">
                                <label class="form-label">URL da Foto</label>
                                <input type="text" v-model="newSpace.image" class="form-control" placeholder="http://...">
                            </div>
                            <button class="btn btn-primary" @click="addSpace" style="width: 100%;">Adicionar Área</button>
                        </div>

                        <h3>Aprovações Pendentes</h3>
                        <div v-for="res in pendingReservations" :key="res.id" class="card" style="border-left: 4px solid orange;">
                            <strong>{{ getSpaceName(res.spaceId) }}</strong>
                            <div>{{ res.userName }} - {{ formatDate(res.date) }}</div>
                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                <button class="btn btn-primary btn-sm" style="flex: 1;" @click="updateStatus(res.id, 'approved')">Aprovar</button>
                                <button class="btn btn-danger btn-sm" style="flex: 1;" @click="updateStatus(res.id, 'rejected')">Rejeitar</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div v-if="currentUser.type !== 'superuser'" class="bottom-nav">
                <div class="nav-item" :class="{active: currentView === 'calendar'}" @click="currentView = 'calendar'"><i class="material-icons">calendar_month</i></div>
                <div class="nav-item" :class="{active: currentView === 'reservations'}" @click="currentView = 'reservations'"><i class="material-icons">receipt_long</i></div>
                <div v-if="currentUser.type === 'syndic'" class="nav-item" :class="{active: currentView === 'admin'}" @click="currentView = 'admin'"><i class="material-icons">verified_user</i></div>
            </div>
        </div>

        <div class="modal-overlay" v-if="showModal" @click.self="showModal = false">
            <div class="modal-content">
                <h3>Reservar {{ selectedSpace?.name }}</h3>
                <p v-if="selectedSpace?.rules" style="background: #FFF3E0; padding: 10px; border-radius: 4px; font-size: 0.9rem; margin-bottom: 15px;">
                    <i class="material-icons" style="font-size: 14px; vertical-align: middle;">warning</i> 
                    <strong>Regras:</strong> {{ selectedSpace.rules }}
                </p>
                <div class="form-group"><label class="form-label">Data</label><input type="date" v-model="form.date" class="form-control"></div>
                <div class="form-group"><label class="form-label">Horário</label><select v-model="form.time" class="form-control"><option>08:00 - 12:00</option><option>13:00 - 17:00</option><option>18:00 - 22:00</option></select></div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-outline" @click="showModal = false">Cancelar</button>
                    <button class="btn btn-primary" @click="confirmBooking">Confirmar</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" v-if="showBlockModal" @click.self="showBlockModal = false">
            <div class="modal-content">
                <h3>Bloquear {{ selectedSpace?.name }}</h3>
                <p style="color: #666;">Isso impedirá novas reservas nesta data.</p>
                <div class="form-group"><label class="form-label">Data do Bloqueio</label><input type="date" v-model="form.date" class="form-control"></div>
                <div class="form-group"><label class="form-label">Motivo</label><input type="text" v-model="form.reason" class="form-control" placeholder="Ex: Manutenção Elétrica"></div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-outline" @click="showBlockModal = false">Cancelar</button>
                    <button class="btn btn-danger" @click="confirmBlock">Bloquear Data</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, computed, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CONFIGURAÇÃO DO FIREBASE (MANTENHA SUAS CHAVES)
        const firebaseConfig = {
            apiKey: "AIzaSyDeWvVtINqz07UK-iCZwG8-rfBJN7insDM",
            authDomain: "condosaas-app.firebaseapp.com",
            projectId: "condosaas-app",
            storageBucket: "condosaas-app.firebasestorage.app",
            messagingSenderId: "1094942324011",
            appId: "1:1094942324011:web:49293ce94269e71807416e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        createApp({
            setup() {
                // Estado Geral
                const currentView = ref('calendar');
                const currentUser = ref(null);
                const condoName = ref('');
                const loading = ref(false);
                const toasts = ref([]);
                
                // Dados
                const spaces = ref([]);
                const reservations = ref([]);
                const condoList = ref([]);

                // Forms
                const authForm = ref({ email: '', password: '' });
                const isRegistering = ref(false);
                const hasUrlCode = ref(false);
                const regForm = ref({ condoId: '', name: '', apartment: '', email: '', password: '' });
                
                const newCondo = ref({});
                const newSpace = ref({ name: '', capacity: '', rules: '', image: '' });
                
                const showModal = ref(false);
                const showBlockModal = ref(false);
                const selectedSpace = ref(null);
                const form = ref({ date: '', time: '13:00 - 17:00', reason: '' });

                // --- AUTH E INICIALIZAÇÃO ---
                onMounted(() => {
                    // Verifica se tem código na URL (QR Code)
                    const urlParams = new URLSearchParams(window.location.search);
                    const code = urlParams.get('code');
                    if (code) {
                        isRegistering.value = true;
                        regForm.value.condoId = code;
                        hasUrlCode.value = true;
                    }
                });

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        try {
                            const userDoc = await getDoc(doc(db, "users", user.uid));
                            if (userDoc.exists()) {
                                const data = userDoc.data();
                                currentUser.value = { uid: user.uid, email: user.email, ...data };
                                
                                if (data.type === 'superuser') {
                                    loadSuperData();
                                } else {
                                    loadCondoData(data.condoId);
                                }
                            }
                        } catch (e) { console.error(e); }
                    } else {
                        currentUser.value = null;
                        spaces.value = [];
                        reservations.value = [];
                    }
                });

                // --- DATA LOADING ---
                const loadCondoData = async (condoId) => {
                    // Carrega Nome
                    const cDoc = await getDoc(doc(db, "condominios", condoId));
                    if (cDoc.exists()) condoName.value = cDoc.data().name;

                    // Carrega Espaços do Condomínio
                    const qSpaces = query(collection(db, "spaces"), where("condoId", "==", condoId));
                    onSnapshot(qSpaces, (snap) => {
                        spaces.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    });

                    // Carrega Reservas
                    const qRes = query(collection(db, "reservations"), where("condoId", "==", condoId));
                    onSnapshot(qRes, (snap) => {
                        reservations.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                };

                const loadSuperData = () => {
                    onSnapshot(collection(db, "condominios"), (snap) => {
                        condoList.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                };

                // --- ACTIONS ---
                const handleLogin = async () => {
                    loading.value = true;
                    try { await signInWithEmailAndPassword(auth, authForm.value.email, authForm.value.password); }
                    catch (e) { showToast("Erro no login", "error"); }
                    finally { loading.value = false; }
                };

                const handleRegister = async () => {
                    // 1. Verificar se Condomínio Existe
                    loading.value = true;
                    try {
                        const condoCheck = await getDoc(doc(db, "condominios", regForm.value.condoId));
                        if (!condoCheck.exists()) throw new Error("Código do condomínio inválido!");

                        // 2. Criar Auth
                        const cred = await createUserWithEmailAndPassword(auth, regForm.value.email, regForm.value.password);
                        
                        // 3. Criar Perfil
                        await setDoc(doc(db, "users", cred.user.uid), {
                            name: regForm.value.name,
                            apartment: regForm.value.apartment,
                            type: 'resident',
                            condoId: regForm.value.condoId,
                            email: regForm.value.email
                        });
                        
                        showToast("Cadastro realizado!", "success");
                        // Limpa URL
                        window.history.replaceState({}, document.title, "/");
                    } catch (e) { showToast(e.message, "error"); }
                    finally { loading.value = false; }
                };

                const addSpace = async () => {
                    if(!newSpace.value.name) return showToast("Nome obrigatório", "error");
                    try {
                        await addDoc(collection(db, "spaces"), {
                            ...newSpace.value,
                            condoId: currentUser.value.condoId
                        });
                        showToast("Área adicionada!");
                        newSpace.value = { name: '', capacity: '', rules: '', image: '' };
                    } catch(e) { showToast("Erro ao salvar", "error"); }
                };

                // Reservas e Bloqueios
                const openBookingModal = (s) => { selectedSpace.value = s; showModal.value = true; };
                const openBlockModal = (s) => { selectedSpace.value = s; showBlockModal.value = true; };

                const confirmBooking = async () => {
                    // Verifica Bloqueio ou Reserva Existente
                    const conflict = reservations.value.find(r => 
                        r.spaceId === selectedSpace.value.id && 
                        r.date === form.value.date && 
                        (r.status === 'approved' || r.status === 'maintenance')
                    );
                    
                    if (conflict) {
                        const msg = conflict.status === 'maintenance' ? "Data bloqueada para manutenção." : "Horário já reservado.";
                        return showToast(msg, "error");
                    }

                    try {
                        await addDoc(collection(db, "reservations"), {
                            condoId: currentUser.value.condoId,
                            spaceId: selectedSpace.value.id,
                            userId: currentUser.value.uid,
                            userName: currentUser.value.name,
                            date: form.value.date,
                            time: form.value.time,
                            status: 'pending' // ou maintenance
                        });
                        showModal.value = false;
                        showToast("Solicitado!");
                    } catch(e) { showToast("Erro", "error"); }
                };

                const confirmBlock = async () => {
                    try {
                        await addDoc(collection(db, "reservations"), {
                            condoId: currentUser.value.condoId,
                            spaceId: selectedSpace.value.id,
                            userId: currentUser.value.uid,
                            userName: "SÍNDICO (Bloqueio)",
                            date: form.value.date,
                            time: "DIA TODO",
                            status: 'maintenance',
                            reason: form.value.reason
                        });
                        showBlockModal.value = false;
                        showToast("Data bloqueada!");
                    } catch(e) { showToast("Erro", "error"); }
                };
                
                // Super User Create Condo
                const createCondo = async () => {
                    try {
                        const cRef = await addDoc(collection(db, "condominios"), { 
                            name: newCondo.value.name, 
                            createdAt: new Date().toISOString() 
                        });
                        // Cria user simulado (na prática seria Cloud Function)
                        const cred = await createUserWithEmailAndPassword(auth, newCondo.value.syndicEmail, newCondo.value.syndicPassword);
                        await setDoc(doc(db, "users", cred.user.uid), {
                            name: "Síndico",
                            email: newCondo.value.syndicEmail,
                            type: 'syndic',
                            condoId: cRef.id
                        });
                        alert("Condomínio Criado! ID: " + cRef.id);
                        window.location.reload();
                    } catch(e) { showToast(e.message, "error"); }
                };

                // Helpers
                const logout = () => signOut(auth);
                const showToast = (m,t) => { toasts.value.push({message:m, type:t}); setTimeout(()=>toasts.value.shift(),3000); };
                const getRegistrationLink = () => {
                    // Pega a URL atual e adiciona o codigo
                    const baseUrl = window.location.href.split('?')[0];
                    return `${baseUrl}?code=${currentUser.value.condoId}`;
                };

                // Calendar Logic
                const currentDate = ref(new Date());
                const monthLabel = computed(() => currentDate.value.toLocaleString('pt-BR', { month: 'long', year: 'numeric' }));
                const daysInMonth = computed(() => new Date(currentDate.value.getFullYear(), currentDate.value.getMonth() + 1, 0).getDate());
                const paddingDays = computed(() => new Date(currentDate.value.getFullYear(), currentDate.value.getMonth(), 1).getDay());
                const changeMonth = (d) => currentDate.value = new Date(currentDate.value.setMonth(currentDate.value.getMonth() + d));
                const isToday = (d) => d === new Date().getDate() && currentDate.value.getMonth() === new Date().getMonth();
                const getReservationsForDay = (d) => {
                    const dt = `${currentDate.value.getFullYear()}-${String(currentDate.value.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    return reservations.value.filter(r => r.date === dt && r.status !== 'rejected');
                };
                const getStatusColor = (s) => s==='maintenance'?'#757575':(s==='approved'?'#4CAF50':(s==='pending'?'#2196F3':'#F44336'));
                
                // UI Helpers
                const getSpaceName = (id) => spaces.value.find(s=>s.id===id)?.name || 'Área Comum';
                const formatDate = (d) => d?.split('-').reverse().join('/');
                const updateStatus = async (id, s) => await updateDoc(doc(db, "reservations", id), { status: s });
                const deleteReservation = async (id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, "reservations", id)); };

                const myReservations = computed(() => reservations.value.filter(r => r.userId === currentUser.value?.uid));
                const pendingReservations = computed(() => reservations.value.filter(r => r.status === 'pending'));

                return {
                    authForm, regForm, isRegistering, handleLogin, handleRegister, hasUrlCode,
                    currentUser, condoName, loading, toasts, currentView,
                    spaces, reservations, condoList,
                    newCondo, newSpace, createCondo, addSpace,
                    showModal, showBlockModal, selectedSpace, form, openBookingModal, openBlockModal, confirmBooking, confirmBlock,
                    myReservations, pendingReservations, updateStatus, deleteReservation,
                    monthLabel, daysInMonth, paddingDays, changeMonth, isToday, getReservationsForDay, getStatusColor,
                    getSpaceName, formatDate, getRegistrationLink, logout
                };
            }
        }).mount('#app');
    </script>
</body>
</html>